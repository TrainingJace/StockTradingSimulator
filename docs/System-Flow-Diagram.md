# 🔄 Stock Trading Simulator 系统流程图

## 1. 用户注册流程

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  用户填写    │    │  前端表单    │    │  后端验证    │    │  密码加密    │
│  注册信息    │───▶│  数据验证    │───▶│  用户名唯一性 │───▶│  bcrypt     │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                                  │
┌─────────────┐    ┌─────────────┐    ┌─────────────┐            ▼
│  返回用户    │    │  自动创建    │    │  创建用户    │    ┌─────────────┐
│  信息+Token │◀───│  投资组合    │◀───│  记录到DB   │◀───│  生成JWT    │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
```

## 2. 用户登录流程

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  输入用户名  │    │  前端数据    │    │  后端查询    │    │  密码验证    │
│  和密码     │───▶│  格式验证    │───▶│  用户是否存在 │───▶│  bcrypt.compare│
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                                  │
┌─────────────┐    ┌─────────────┐    ┌─────────────┐            ▼
│  前端保存    │    │  返回用户    │    │  生成JWT    │    ┌─────────────┐
│  Token+信息 │◀───│  信息+Token │◀───│  Token      │◀───│  验证成功    │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
```

## 3. 股票交易流程 (买入)

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  用户选择    │    │  获取股票    │    │  用户输入    │    │  前端数据    │
│  股票       │───▶│  当前价格    │───▶│  买入数量    │───▶│  验证       │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                                  │
                   ┌─────────────┐    ┌─────────────┐            ▼
                   │  开始数据库  │    │  检查用户    │    ┌─────────────┐
                   │  事务       │◀───│  资金余额    │◀───│  发送买入    │
                   └─────────────┘    └─────────────┘    │  请求到后端  │
                           │                            └─────────────┘
                           ▼
                   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
                   │  更新或创建  │    │  扣除现金    │    │  创建交易    │
                   │  持仓记录    │───▶│  余额       │───▶│  记录       │
                   └─────────────┘    └─────────────┘    └─────────────┘
                           │                                      │
                           ▼                                      ▼
                   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
                   │  提交事务    │    │  更新投资组合│    │  写入历史    │
                   │             │───▶│  总价值     │───▶│  快照       │
                   └─────────────┘    └─────────────┘    └─────────────┘
                           │
                           ▼
                   ┌─────────────┐
                   │  返回成功    │
                   │  结果给前端  │
                   └─────────────┘
```

## 4. 股票交易流程 (卖出)

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  用户选择    │    │  检查当前    │    │  用户输入    │    │  前端数据    │
│  持有股票    │───▶│  持仓数量    │───▶│  卖出数量    │───▶│  验证       │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                                  │
                   ┌─────────────┐    ┌─────────────┐            ▼
                   │  开始数据库  │    │  检查持仓    │    ┌─────────────┐
                   │  事务       │◀───│  数量是否足够 │◀───│  发送卖出    │
                   └─────────────┘    └─────────────┘    │  请求到后端  │
                           │                            └─────────────┘
                           ▼
                   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
                   │  更新持仓    │    │  增加现金    │    │  创建交易    │
                   │  或删除记录  │───▶│  余额       │───▶│  记录       │
                   └─────────────┘    └─────────────┘    └─────────────┘
                           │                                      │
                           ▼                                      ▼
                   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
                   │  提交事务    │    │  更新投资组合│    │  写入历史    │
                   │             │───▶│  总价值     │───▶│  快照       │
                   └─────────────┘    └─────────────┘    └─────────────┘
                           │
                           ▼
                   ┌─────────────┐
                   │  返回成功    │
                   │  结果给前端  │
                   └─────────────┘
```

## 5. 股票数据获取和更新流程

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  定时任务    │    │  调用外部    │    │  Finnhub    │    │  Alpha      │
│  触发       │───▶│  API接口    │───▶│  实时数据    │    │  Vantage    │
└─────────────┘    └─────────────┘    └─────────────┘    │  历史数据    │
                                                        └─────────────┘
                                                                  │
                   ┌─────────────┐    ┌─────────────┐            ▼
                   │  数据格式化  │    │  存储到      │    ┌─────────────┐
                   │  和验证     │◀───│  MySQL数据库 │◀───│  获取数据    │
                   └─────────────┘    └─────────────┘    └─────────────┘
                           │
                           ▼
                   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
                   │  更新所有    │    │  计算未实现  │    │  触发前端    │
                   │  用户持仓价值 │───▶│  收益/亏损   │───▶│  数据更新    │
                   └─────────────┘    └─────────────┘    └─────────────┘
```

## 6. 投资组合分析流程

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  用户请求    │    │  获取用户    │    │  计算投资组合│    │  获取历史    │
│  分析数据    │───▶│  投资组合    │───▶│  当前价值    │───▶│  价值数据    │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                                  │
                   ┌─────────────┐    ┌─────────────┐            ▼
                   │  生成图表    │    │  计算收益率  │    ┌─────────────┐
                   │  数据       │◀───│  风险指标    │◀───│  获取基准    │
                   └─────────────┘    └─────────────┘    │  比较数据    │
                           │                            └─────────────┘
                           ▼
                   ┌─────────────┐
                   │  返回分析    │
                   │  结果给前端  │
                   └─────────────┘
```

## 7. 每日结算流程

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  定时任务    │    │  获取所有    │    │  更新股票    │    │  重新计算    │
│  (每日凌晨)  │───▶│  活跃用户    │───▶│  最新价格    │───▶│  持仓价值    │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                                  │
                   ┌─────────────┐    ┌─────────────┐            ▼
                   │  更新用户    │    │  写入投资组合│    ┌─────────────┐
                   │  模拟日期    │◀───│  历史快照    │◀───│  计算收益    │
                   └─────────────┘    └─────────────┘    │  和风险指标  │
                           │                            └─────────────┘
                           ▼
                   ┌─────────────┐
                   │  发送日报    │
                   │  (可选)     │
                   └─────────────┘
```

## 8. 新闻数据集成流程

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  定时获取    │    │  调用新闻    │    │  内容过滤    │    │  情感分析    │
│  市场新闻    │───▶│  API        │───▶│  和清理     │───▶│  处理       │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                                  │
                   ┌─────────────┐    ┌─────────────┐            ▼
                   │  用户查看    │    │  存储新闻    │    ┌─────────────┐
                   │  相关新闻    │◀───│  到数据库    │◀───│  标记股票    │
                   └─────────────┘    └─────────────┘    │  关联性     │
                                                        └─────────────┘
```

## 9. 观察列表管理流程

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  用户添加    │    │  验证股票    │    │  检查是否    │    │  添加到      │
│  股票到观察  │───▶│  是否存在    │───▶│  已在列表中  │───▶│  观察列表    │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                                  │
                   ┌─────────────┐    ┌─────────────┐            ▼
                   │  显示观察    │    │  获取股票    │    ┌─────────────┐
                   │  列表       │◀───│  实时价格    │◀───│  数据库      │
                   └─────────────┘    └─────────────┘    │  记录       │
                           │                            └─────────────┘
                           ▼
                   ┌─────────────┐
                   │  用户可移除  │
                   │  或交易     │
                   └─────────────┘
```

## 10. 系统安全验证流程

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  用户请求    │    │  检查请求    │    │  JWT Token  │    │  验证Token  │
│  受保护资源  │───▶│  Header     │───▶│  提取       │───▶│  有效性     │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                                  │
                                                                  ▼
                                                         ┌─────────────┐
                                        ┌───────────────▶│  Token有效   │
                                        │                └─────────────┘
                   ┌─────────────┐      │                        │
                   │  返回错误    │      │                        ▼
                   │  401未授权   │◀─────┤                ┌─────────────┐
                   └─────────────┘      │                │  解析用户ID  │
                                        │                └─────────────┘
                                        │                        │
                                        │                        ▼
                   ┌─────────────┐      │                ┌─────────────┐
                   │  Token无效   │◀─────┘                │  执行业务    │
                   │  或过期     │                       │  逻辑       │
                   └─────────────┘                       └─────────────┘
```

## 11. 错误处理和日志流程

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  系统发生    │    │  捕获错误    │    │  记录错误    │    │  确定错误    │
│  异常       │───▶│  信息       │───▶│  到日志     │───▶│  类型和级别  │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                                  │
                   ┌─────────────┐    ┌─────────────┐            ▼
                   │  前端显示    │    │  格式化错误  │    ┌─────────────┐
                   │  用户友好    │◀───│  响应消息    │◀───│  数据库回滚  │
                   │  错误信息    │    └─────────────┘    │  (如果需要)  │
                   └─────────────┘                      └─────────────┘
                           │
                           ▼
                   ┌─────────────┐
                   │  用户重试    │
                   │  或联系支持  │
                   └─────────────┘
```

## 12. 数据一致性保证流程

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  开始复杂    │    │  开启数据库  │    │  执行多个    │    │  验证数据    │
│  业务操作    │───▶│  事务       │───▶│  相关操作    │───▶│  完整性     │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                                  │
                                                                  ▼
                                                         ┌─────────────┐
                                        ┌───────────────▶│  验证成功    │
                                        │                └─────────────┘
                   ┌─────────────┐      │                        │
                   │  回滚所有    │      │                        ▼
                   │  操作       │◀─────┤                ┌─────────────┐
                   └─────────────┘      │                │  提交事务    │
                           │            │                └─────────────┘
                           ▼            │                        │
                   ┌─────────────┐      │                        ▼
                   │  返回错误    │      │                ┌─────────────┐
                   │  信息       │      │                │  操作成功    │
                   └─────────────┘      │                │  完成       │
                                        │                └─────────────┘
                                        │
                   ┌─────────────┐      │
                   │  验证失败    │◀─────┘
                   │  或异常     │
                   └─────────────┘
```
